import { useEffect, useMemo, useState } from "react";
import EncaminhamentosSuas from "./components/EncaminhamentosSuas.jsx";
import "./cras_enc_splitview.css";

const STATUS_ORDER = ["enviado","recebido","agendado","atendido","devolutiva","concluido"];
const STATUS_LABEL = {
  enviado: "ENVIADO",
  recebido: "RECEBIDO",
  agendado: "AGENDADO",
  atendido: "ATENDIDO",
  devolutiva: "DEVOLUTIVA",
  concluido: "CONCLUÍDO",
  cancelado: "CANCELADO",
};

function StatusPill({ status }) {
  const s = (status || "enviado").toLowerCase();
  const label = STATUS_LABEL[s] || String(s).toUpperCase();
  return <span className={`cras-pill cras-pill--${s}`}>{label}</span>;
}

function FlowMini({ status }) {
  const s = (status || "enviado").toLowerCase();
  const idx = STATUS_ORDER.indexOf(s);

  const steps = [
    { key: "enviado", label: "Enviado" },
    { key: "recebido", label: "Recebido" },
    { key: "agendado", label: "Agendado" },
    { key: "atendido", label: "Atendido" },
    { key: "devolutiva", label: "Devolutiva" },
    { key: "concluido", label: "Concluído" },
  ];

  // cancelado: marca tudo como "parado"
  if (s === "cancelado") {
    return (
      {/* REMOVIDO_HEADER_PADRAO_V1 */}



      {msg ? <div className="enc-panel enc-panel-filtros card" style={{ padding: 12, borderRadius: 14 }}><strong>{msg}</strong></div> : null}


      <div className="enc-panel enc-panel-novo card" style={{ padding: 12, borderRadius: 18 }}>
        <div style={{ display: "flex", gap: 10, flexWrap: "wrap", alignItems: "end" }}>
          <div style={{ flex: "1 1 260px" }}>
            <label className="label">Unidade CRAS</label>
            <select className="input" value={unidadeId} onChange={(e) => setUnidadeId(e.target.value)}>
              <option value="">Selecione…</option>
              {unidades.map((u) => <option key={u.id} value={u.id}>{u.nome}</option>)}
            </select>
          </div>

          <div style={{ flex: "1 1 220px" }}>
            <label className="label">Destino</label>
            <select className="input" value={destinoFiltro} onChange={(e) => setDestinoFiltro(e.target.value)}>
              <option value="">Todos</option>
              {destinosMeta.map((d) => <option key={d.codigo} value={d.codigo}>{d.nome}</option>)}
            </select>
          </div>

          <div style={{ display: "flex", gap: 10, alignItems: "center" }}>
            <button className="btn btn-secundario" type="button" onClick={loadList}>Atualizar</button>

            <div className="enc-panel enc-panel-semdev card" style={{ padding: "10px 12px", borderRadius: 14, border: "1px solid rgba(245,158,11,.28)", background: "rgba(255,247,237,.72)" }}>
              <div className="texto-suave" style={{ fontWeight: 900 }}>Sem devolutiva</div>
              <div style={{ fontSize: 18, fontWeight: 950 }}>{semDevolutiva.length}</div>
            </div>
          </div>
        </div>
      </div>

      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
        <div className="enc-panel enc-panel-novo card /* ENC_PANELS_V1 */" style={{ padding: 12, borderRadius: 18 }}>
          <h3 style={{ margin: 0 }}>Novo encaminhamento</h3>
          <p className="texto-suave" style={{ marginTop: 6 }}>
            Defina um prazo por item para cobrança automática (“sem devolutiva”).
          </p>

          <div style={{ display: "grid", gap: 8 }}>
            <div>
              <label className="label">Pessoa (opcional)</label>
              <select className="input" value={form.pessoa_id} onChange={(e) => setForm({ ...form, pessoa_id: e.target.value })}>
                <option value="">Selecione…</option>
                {pessoas.map((p) => (
                  <option key={p.id} value={p.id}>#{p.id} — {p.nome_social || p.nome_civil || "Pessoa"}</option>
                ))}
              </select>
            </div>

            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
              <div>
                <label className="label">Destino (tipo)</label>
                <select className="input" value={form.destino_tipo} onChange={(e) => setForm({ ...form, destino_tipo: e.target.value })}>
                  {destinosMeta.map((d) => <option key={d.codigo} value={d.codigo}>{d.nome}</option>)}
                </select>
              </div>

              <div>
                <label className="label">Prazo devolutiva (dias)</label>
                <input className="input" value={form.prazo_devolutiva_dias} onChange={(e) => setForm({ ...form, prazo_devolutiva_dias: e.target.value })} />
              </div>
            </div>

            <div>
              <label className="label">Destino (nome)</label>
              <input className="input" value={form.destino_nome} onChange={(e) => setForm({ ...form, destino_nome: e.target.value })} placeholder="Ex.: UBS Centro, Escola X, CREAS..." />
            </div>

            <div>
              <label className="label">Motivo</label>
              <input className="input" value={form.motivo} onChange={(e) => setForm({ ...form, motivo: e.target.value })} placeholder="Ex.: avaliação, atualização, acompanhamento..." />
            </div>

            <div>
              <label className="label">Observação (operacional)</label>
              <textarea className="input" rows={4} value={form.observacao_operacional} onChange={(e) => setForm({ ...form, observacao_operacional: e.target.value })} />
            </div>

            <div style={{ display: "flex", gap: 10, flexWrap: "wrap" }}>
              <button className="btn btn-primario" type="button" onClick={criar}>Criar encaminhamento</button>
              <button className="btn btn-secundario" type="button" onClick={() => setForm({ ...form, destino_nome: "", motivo: "", observacao_operacional: "" })}>
                Limpar
              </button>
            </div>
          </div>
        </div>

        <div id="sem-devolutiva-panel" className="enc-panel enc-panel-semdev card /* ENC_PANELS_V1 */" style={{ padding: 12, borderRadius: 18 }}>
          <h3 style={{ margin: 0 }}>Sem devolutiva (atrasados)</h3>
          <p className="texto-suave" style={{ marginTop: 6 }}>Atraso calculado pelo prazo do próprio encaminhamento.</p>

          <div style={{ display: "grid", gap: 8, marginTop: 8 }}>
            {semDevolutiva.length ? semDevolutiva.map((e) => (
              <div
                id={`cras_enc_${e.id}`}
                key={e.id}
                className="card"
                style={{
                  padding: 10,
                  borderRadius: 14,
                  border: String(e.id) === String(focusEncId) ? "2px solid rgba(59,130,246,.40)" : "1px solid rgba(229,231,235,0.9)",
                  background: String(e.id) === String(focusEncId) ? "rgba(239,246,255,.70)" : undefined,
                }}
              >
                <div style={{ display: "flex", justifyContent: "space-between", gap: 10, flexWrap: "wrap", alignItems: "center" }}>
                  <div><b>#{e.id}</b> · {e.destino_nome}</div>
                  <StatusPill status={e.status} />
                </div>

                <div style={{ marginTop: 6 }}>
                  <FlowMini status={e.status} />
                </div>

                <div className="texto-suave" style={{ marginTop: 6 }}>
                  Tipo: {e.destino_tipo} · Pessoa: {e.pessoa_id ? `#${e.pessoa_id}` : "—"} · aberto: <b>{e.dias_aberto}</b>d · prazo: <b>{e.prazo_usado}</b>d
                </div>

                <div style={{ display: "flex", gap: 8, marginTop: 8, flexWrap: "wrap" }}>
                  <button className="btn btn-primario" type="button" onClick={() => registrarDevolutiva(e)}>Registrar devolutiva</button>
                  <button className="btn btn-secundario" type="button" onClick={() => cobrar(e)}>Cobrar</button>
                  <button className="btn btn-secundario" type="button" onClick={() => avancar(e)}>Avançar</button>
                </div>
              </div>
            )) : (
              <div className="texto-suave">Nenhum item atrasado.</div>
            )}
          </div>
        </div>
      </div>

      <div className="card" style={{ padding: 12, borderRadius: 18 }}>
        <h3 style={{ margin: 0 }}>Todos os encaminhamentos</h3>
        <p className="texto-suave" style={{ marginTop: 6 }}>
          Unidade: <b>{unidadeNome}</b> {destinoFiltro ? <>· Filtro: <b>{destinoFiltro}</b></> : null}
        </p>

        <div style={{ display: "grid", gap: 8, marginTop: 8 }}>
          {lista.length ? lista.map((e) => (
            <div
              id={`cras_enc_${e.id}`}
              key={e.id}
              className="card"
              style={{
                padding: 10,
                borderRadius: 14,
                border: String(e.id) === String(focusEncId) ? "2px solid rgba(59,130,246,.40)" : "1px solid rgba(229,231,235,0.9)",
                background: String(e.id) === String(focusEncId) ? "rgba(239,246,255,.70)" : undefined,
              }}
            >
              <div style={{ display: "flex", justifyContent: "space-between", gap: 10, flexWrap: "wrap", alignItems: "center" }}>
                <div><b>#{e.id}</b> · {e.destino_nome}</div>
                <StatusPill status={e.status} />
              </div>

              <div style={{ marginTop: 6 }}>
                <FlowMini status={e.status} />
              </div>

              <div className="texto-suave" style={{ marginTop: 6 }}>
                Tipo: {e.destino_tipo} · Pessoa: {e.pessoa_id ? `#${e.pessoa_id}` : "—"} · Prazo: <b>{e.prazo_devolutiva_dias || 7}d</b>
              </div>

              <div style={{ display: "flex", gap: 8, marginTop: 8, flexWrap: "wrap" }}>
                <button className="btn btn-secundario" type="button" onClick={() => avancar(e)}>Avançar</button>
                <button className="btn btn-secundario" type="button" onClick={() => registrarDevolutiva(e)}>Devolutiva</button>
                <button className="btn btn-secundario" type="button" onClick={() => cobrar(e)}>Cobrar</button>
                <button className="btn btn-secundario" type="button" onClick={() => cancelar(e)}>Cancelar</button>
              </div>
            </div>
          )) : (
            <div className="texto-suave">Nenhum encaminhamento nesta unidade.</div>
          )}
        </div>
      </div>
          </div>
        </div>
        <div className="cras-enc-right">
      <EncaminhamentosSuas
        modulo="CRAS"
        usuarioLogado={usuarioLogado}
        allowCreate={true}
        pessoasOptions={pessoasOptionsSuas}
        onAcceptCreateCaso={(item) => createCrasCaseFromSuasEncaminhamento(item)}
        onOpenDestinoCaso={(item) => abrirCasoCras(item)}
        title="Encaminhamentos SUAS"
        subtitle="CRAS ⇄ CREAS ⇄ PopRua, com recebimento e contrarreferência."
      />
        </div>
      </div>
    </div>
  );
}
